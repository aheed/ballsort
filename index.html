<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <title>Ball Sorter</title>
    <style>
        .h-move {
            transition: transform 1s;
        }
        .v-move {
            transition: transform 1.5s;
            transition-timing-function: ease-in-out;
        }
        .claw {
          transition: transform 0.3s;
          transition-timing-function: ease-in;
        }
    </style>
  </head>
  <body>
    <svg id="movers-svg" height="500" width="500">
        <circle id="c1" class="h-move" cx="50" cy="50" r="16" stroke="black" stroke-width="3" fill="red" />
        Sorry, your browser does not support inline SVG.
    </svg>
    <br>
    <button id="move-horiz" type="button">&lt;---&gt;</button>
    <button id="move-down" type="button">⬇️</button>
    <button id="claw-toggle" type="button">Grab!</button>
    <div id="status-msg">starting up...</div>
    <script type="module">
      const statusMsg = document.querySelector("#status-msg");
      const c1 = document.querySelector("#c1");
      const hButton = document.querySelector("#move-horiz");
      const downButton = document.querySelector("#move-down");
      const clawButton = document.querySelector("#claw-toggle");
      const moversSvg = document.querySelector("#movers-svg");
      const hDistance = 150;
      const vDistanceMin = 5;
      const vDistanceMax = 25;
      const hPositions = 3;
      const vPositions = 5;
      const nofMovers = 20;
      const cb0Min = 0.55;
      const cb0Max = 0.95;
      const cb1Min = 0.1;
      const cb1Max = 0.1;
      const cb2Min = 0.5;
      const cb2Max = 0.6;
      const cb3Min = 1.0;
      const cb3Max = 1.4;
      const originX = 50;
      const originY = 70;
      const clawOpenAngleDegrees = 58;
      const clawClosedAngleDegrees = 25;
      let clawOpen = true;

      let hPosIndex = 0;
      let hPos = 0;
      let vPosIndex = 0;

      const ipol = (index, min, max, maxIndex) => min + index * (max - min) / maxIndex;
      const ipolCurried = (min, max, maxIndex) => (index) => ipol(index, min, max, maxIndex);
      const ipolCurriedMax = (maxIndex) => (min, max) => ipolCurried(min, max, maxIndex);
      const ipolCurriedMaxFun = ipolCurriedMax(nofMovers - 1);
      const ipFun0 = ipolCurriedMaxFun(cb0Min, cb0Max);
      const ipFun1 = ipolCurriedMaxFun(cb1Min, cb1Max);
      const ipFun2 = ipolCurriedMaxFun(cb2Min, cb2Max);
      const ipFun3 = ipolCurriedMaxFun(cb3Min, cb3Max);
      let clawLeft;
      let clawRight;

      const setClawAttributes = (elem) => {
        elem.setAttribute('fill', "none");
        elem.setAttribute('stroke', "orange");
        elem.setAttribute('stroke-width', "8");
        elem.setAttribute('transform-origin', `${originX}px ${originY}px`);
        elem.classList.add('claw');
      }

      const hMovers = [];
      const vMovers = [];
      for (let i=0; i<nofMovers; i++) {
        const vMover = document.createElementNS("http://www.w3.org/2000/svg", 'g');
        vMover.classList.add('v-move');
        vMovers.push(vMover);
        let mover;
        if (i < (nofMovers - 1)) {
          mover = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
          mover.setAttribute('stroke', 'none');
          mover.setAttribute('fill', 'black');
          mover.setAttribute('cx', `${originX}`);
          mover.setAttribute('cy', `${originY}`);
          mover.setAttribute('r', '16');
          mover.setAttribute('stroke-width', '3');
        }
        else {
          mover = document.createElementNS("http://www.w3.org/2000/svg", 'g');
          clawRight = document.createElementNS("http://www.w3.org/2000/svg", 'path');
          clawRight.setAttribute('id', "claw-right");
          clawRight.setAttribute('d', `M${originX},${originY} a20,20 0 0,1 0,40`);
          setClawAttributes(clawRight);
          mover.appendChild(clawRight);

          clawLeft = document.createElementNS("http://www.w3.org/2000/svg", 'path');
          clawLeft.setAttribute('id', "claw-left");
          clawLeft.setAttribute('d', `M${originX},${originY} a20,20 0 0,0 0,40`);
          setClawAttributes(clawLeft);
          mover.appendChild(clawLeft);
        }
        const transFun = `cubic-bezier(${ipFun0(i)}, ${ipFun1(i)}, ${ipFun2(i)}, ${ipFun3(i)}`;
        mover.style['transition-timing-function'] = transFun;
        mover.classList.add('h-move');
        hMovers.push(mover);
        vMover.appendChild(mover);
      }

      vMovers.forEach(vMover => {
        moversSvg.appendChild(vMover);
      });

      const updatePositions = () => {
        hPos = hPosIndex * hDistance;
        console.log(`hPosIx: ${hPosIndex} hPos:${hPos}`);
        c1.style.transform = `translateX(${hPos}px)`;
        const vPosFun = ipolCurried(vDistanceMin, vDistanceMax, vPositions - 1);
        hMovers.forEach((mover, i) => {
            mover.style.transform = `translateX(${hPos}px)`;
        });
        vMovers.forEach((mover, i) => {
            let vDistance = vPosFun(vPosIndex);
            let vPos = Math.floor(i * vDistance);
            mover.style.transform = `translateY(${vPos}px)`;
        });
        const clawAngleDegrees = clawOpen ? clawOpenAngleDegrees : clawClosedAngleDegrees;
        clawRight.style.transform = `rotate(${-clawAngleDegrees}deg)`;
        clawLeft.style.transform = `rotate(${clawAngleDegrees}deg)`;
      }

      const horizClickHandler = (e) => {
        console.log("move horizontally");
        hPosIndex = (hPosIndex + 1) % hPositions;
        updatePositions();
      }

      const downClickHandler = (e) => {
        console.log("move down");
        vPosIndex = (vPosIndex + 1) % vPositions;
        updatePositions();
      }

      const clawClickHandler = (e) => {
        console.log("toggle claw");
        clawOpen = !clawOpen;
        updatePositions();
      }

      hButton.addEventListener("click", horizClickHandler);
      downButton.addEventListener("click", downClickHandler);
      clawButton.addEventListener("click", clawClickHandler);
      hButton.focus();
      updatePositions();

      console.log("so far so good");
      statusMsg.innerText = "Done!";


    </script>
  </body>
</html>