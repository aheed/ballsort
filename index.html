<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <title>Ball Sorter</title>
    <style>
        .h-move {
            transition: transform 1s;
        }
        .v-move {
            transition: transform 1.5s;
            transition-timing-function: ease-in-out;
        }
        .claw {
          transition: transform 0.3s;
          transition-timing-function: ease-in;
        }
        button {
          font-size: 40px;
        }
    </style>
  </head>
  <body>
    <svg id="movers-svg" height="500" width="500">
        Sorry, your browser does not support inline SVG.
    </svg>
    <br>
    <button id="move-horiz" type="button">‚ÜîÔ∏è</button>
    <button id="move-down" type="button">‚ÜïÔ∏è</button>
    <button id="claw-toggle" type="button">ü§è</button>
    <div id="status-msg">starting up...</div>
    <script type="module">
      const statusMsg = document.querySelector("#status-msg");
      const hButton = document.querySelector("#move-horiz");
      const downButton = document.querySelector("#move-down");
      const clawButton = document.querySelector("#claw-toggle");
      const moversSvg = document.querySelector("#movers-svg");
      const hDistance = 100;
      const vTopSpace = 180;
      const vDistance = 50;
      const vOffsetClaw = -25;
      const hPositions = 4;
      const vPositions = 5;
      const nofMovers = 20;
      const cb0Min = 0.55;
      const cb0Max = 0.95;
      const cb1Min = 0.1;
      const cb1Max = 0.1;
      const cb2Min = 0.5;
      const cb2Max = 0.6;
      const cb3Min = 1.0;
      const cb3Max = 1.4;
      const originX = 50;
      const originY = 70;
      const clawOpenAngleDegrees = 58;
      const clawClosedAngleDegrees = 25;
      const ballHolderOffset = 24;
      let clawOpen = false;

      let hPosIndex = 0;
      let hPos = 0;
      let vPosIndex = 0;

      const ipol = (index, min, max, maxIndex) => min + index * (max - min) / maxIndex;
      const ipolCurried = (min, max, maxIndex) => (index) => ipol(index, min, max, maxIndex);
      const ipolCurriedMax = (maxIndex) => (min, max) => ipolCurried(min, max, maxIndex);
      const ipolCurriedMaxFun = ipolCurriedMax(nofMovers - 1);
      const ipFun0 = ipolCurriedMaxFun(cb0Min, cb0Max);
      const ipFun1 = ipolCurriedMaxFun(cb1Min, cb1Max);
      const ipFun2 = ipolCurriedMaxFun(cb2Min, cb2Max);
      const ipFun3 = ipolCurriedMaxFun(cb3Min, cb3Max);
      let clawLeft;
      let clawRight;

      const setClawAttributes = (elem) => {
        elem.setAttribute('fill', "none");
        elem.setAttribute('stroke', "black");
        elem.setAttribute('stroke-width', "8");
        elem.setAttribute('transform-origin', `${originX}px ${originY}px`);
        elem.classList.add('claw');
      }

      const hMovers = [];
      const vMovers = [];
      let ballHolderInClawElem;
      for (let i=0; i<nofMovers; i++) {
        const vMover = document.createElementNS("http://www.w3.org/2000/svg", 'g');
        vMover.classList.add('v-move');
        vMovers.push(vMover);
        let mover;
        if (i < (nofMovers - 1)) {
          mover = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
          mover.setAttribute('stroke', 'none');
          mover.setAttribute('fill', 'black');
          mover.setAttribute('cx', `${originX}`);
          mover.setAttribute('cy', `${originY}`);
          mover.setAttribute('r', '11');
          mover.setAttribute('stroke-width', '3');
        }
        else {
          mover = document.createElementNS("http://www.w3.org/2000/svg", 'g');
          const ballHolder = document.createElementNS("http://www.w3.org/2000/svg", 'g');
          ballHolder.style.transform = `translateY(${ballHolderOffset}px)`;
          mover.appendChild(ballHolder);
          ballHolderInClawElem = ballHolder;
          vMover.classList.add('claw-wrapper');
          clawRight = document.createElementNS("http://www.w3.org/2000/svg", 'path');
          clawRight.setAttribute('id', "claw-right");
          clawRight.setAttribute('d', `M${originX},${originY} a20,20 0 0,1 0,40`);
          setClawAttributes(clawRight);
          mover.appendChild(clawRight);

          clawLeft = document.createElementNS("http://www.w3.org/2000/svg", 'path');
          clawLeft.setAttribute('id', "claw-left");
          clawLeft.setAttribute('d', `M${originX},${originY} a20,20 0 0,0 0,40`);
          setClawAttributes(clawLeft);
          mover.appendChild(clawLeft);

          const clawHinge = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
          clawHinge.setAttribute('fill', 'black');
          clawHinge.setAttribute('cx', `${originX}`);
          clawHinge.setAttribute('cy', `${originY - 2}`);
          clawHinge.setAttribute('r', '6');
          clawHinge.setAttribute('stroke', 'none');
          mover.appendChild(clawHinge);

          const clawBolt = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
          clawBolt.setAttribute('fill', 'white');
          clawBolt.setAttribute('cx', `${originX}`);
          clawBolt.setAttribute('cy', `${originY - 2}`);
          clawBolt.setAttribute('r', '2');
          clawBolt.setAttribute('stroke', 'none');
          mover.appendChild(clawBolt);
        }
        const transFun = `cubic-bezier(${ipFun0(i)}, ${ipFun1(i)}, ${ipFun2(i)}, ${ipFun3(i)}`;
        mover.style['transition-timing-function'] = transFun;
        mover.classList.add('h-move');
        hMovers.push(mover);
        vMover.appendChild(mover);
      }

      vMovers.forEach(vMover => {
        moversSvg.appendChild(vMover);
      });

      const createBallCircle = (color) => {
        const ret = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
        ret.setAttribute('stroke', 'black');
        ret.setAttribute('fill', color);
        ret.setAttribute('cx', `${originX}`);
        ret.setAttribute('cy', `${originY}`);
        ret.setAttribute('r', '18');
        ret.setAttribute('stroke-width', '2');
        ret.classList.add('ball');
        return ret;
      }

      const createBallWrapper = (color) => {
        const grayBall = createBallCircle('lightgray');
        const coloredBall = createBallCircle(color);
        const wrapper = document.createElementNS("http://www.w3.org/2000/svg", 'g');
        wrapper.classList.add('ball-wrapper');
        wrapper.appendChild(grayBall);
        wrapper.appendChild(coloredBall);
        return wrapper;
      }

      const createBall = (hIndex, vIndex, color) => {
        const wrapper = createBallWrapper(color);
        moversSvg.appendChild(wrapper);
        return {hIndex: hIndex, vIndex: vIndex, wrapper: wrapper, color: color};
      }

      const createBallInClaw = (color) => {
        const wrapper = createBallWrapper(color);
        return {wrapper: wrapper, color: color};
      }

      let balls = [];
      let ballInClaw;

      ///////////////
      balls.push(createBall(0, 1, 'blue'));
      balls.push(createBall(0, 2, 'red'));
      balls.push(createBall(0, 3, 'pink'));
      balls.push(createBall(0, 4, 'green'));
      balls.push(createBall(1, 4, 'green'));
      balls.push(createBall(2, 4, 'green'));
      balls.push(createBall(3, 4, 'green'));

      ballInClaw = createBallInClaw('orange');
      ballHolderInClawElem.appendChild(ballInClaw.wrapper);
      ///////////////


      const updatePositions = () => {
        hPos = hPosIndex * hDistance;
        console.log(`hPosIx: ${hPosIndex} vPosIx: ${vPosIndex} hPos:${hPos}`);
        const vPosFun = ipolCurried(0, vTopSpace + vOffsetClaw + vPosIndex * vDistance, vMovers.length - 2);
        hMovers.forEach((mover, i) => {
            mover.style.transform = `translateX(${hPos}px)`;
        });
        vMovers.forEach((mover, i) => {
          let index = i;
          let offset = -15;
          if (mover.classList.contains('claw-wrapper')) {
            index = index - 1;
            offset = 1;
          }

          let vPos = vPosFun(index) + offset;
          mover.style.transform = `translateY(${vPos}px)`;
        });
        const clawAngleDegrees = clawOpen ? clawOpenAngleDegrees : clawClosedAngleDegrees;
        clawRight.style.transform = `rotate(${-clawAngleDegrees}deg)`;
        clawLeft.style.transform = `rotate(${clawAngleDegrees}deg)`;

        balls.forEach((ball) => {
          const hPosBall = ball.hIndex * hDistance;
          const vPosBall = vTopSpace + ball.vIndex * vDistance;
          ball.wrapper.style.transform = `translate(${hPosBall}px, ${vPosBall}px)`;
        });
      }

      const horizClickHandler = (e) => {
        console.log("move horizontally");
        hPosIndex = (hPosIndex + 1) % hPositions;
        updatePositions();
      }

      const downClickHandler = (e) => {
        console.log("move down");
        vPosIndex = (vPosIndex + 1) % vPositions;
        updatePositions();
      }

      const clawClickHandler = (e) => {
        clawOpen = !clawOpen;
        if(clawOpen) {
          if (!!ballInClaw) {
            console.log("Dropping ball");
            balls.push(createBall(hPosIndex, vPosIndex, ballInClaw.color));
            ballHolderInClawElem.removeChild(ballInClaw.wrapper);
            ballInClaw = null;
          }
        }
        else {
          const ballToGrab = balls.find((ball) => ball.hIndex == hPosIndex && ball.vIndex == vPosIndex);
          if (!!ballToGrab) {
            console.log("Grabbing ball");
            ballInClaw = createBallInClaw(ballToGrab.color);
            ballHolderInClawElem.appendChild(ballInClaw.wrapper);
            moversSvg.removeChild(ballToGrab.wrapper);
            balls = balls.filter((ball) => ball != ballToGrab);
          }
        }
        updatePositions();
      }

      hButton.addEventListener("click", horizClickHandler);
      downButton.addEventListener("click", downClickHandler);
      clawButton.addEventListener("click", clawClickHandler);
      hButton.focus();
      updatePositions();

      console.log("so far so good");
      statusMsg.innerText = "";


    </script>
  </body>
</html>